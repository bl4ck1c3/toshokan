(function ($) {

  $.fn.addResource = function(openUrl, id, service_list, options, manipulation_func) {
    var base = $(this);
    var customData = encodeURIComponent(JSON.stringify({"id" : id}));
    var url = ['<%= Toshokan::Application.config.getit[:url] %>',
               "/resolve?" + openUrl,                
               "&rft.data=" + customData,
               "&req_id=" + userType,
               "&svc_dat=" + service_list].join("");
        
    manipulation_func = typeof manipulation_func !== 'undefined' ? manipulation_func : 'append';

    var spin_options = $.extend({
      length: 3,
      width: 3,
      radius: 3
    }, options);
    
    base[manipulation_func]().spin(spin_options);

    var source = new EventSource(url);
    source.onmessage = function (event) {
      base[manipulation_func](layout(JSON.parse(event.data)));
    }
    source.onerror = function(event) {
      stop();
    }    
    source.addEventListener("close", function(event) {      
      stop();
    }, false);

    function stop() {
      base.spin(false);      
      source.close();
    }

    function layout(data) {
      switch(data.service_type) {
        case "fulltext":
          if(data.subtype.match(/_scan/)) {
            return layout_scan(data);
          } else {
            return layout_fulltext(data);
          }
          break;
      }
    }

    function layout_scan(data) {
      //TODO replace with order functionality
      return $("<li />").html("Order link comes here");
    }

    function layout_fulltext(data) {
      
      var link = $("<a/>", {
        text: data.text,
        "class" : "fulltext " + data.subtype,
        "title": data.note,
        "href" : data.url,
        "data-toggle" : "tooltip"  
      });

      if(data.subtype == "openaccess") {
        $(link).prepend("<i class=\"icon-openaccess\"></i> ");
      } else if(data.subtype == "license") {
        $(link).prepend("<i class=\"icon-download\"></i> ");
      }

      $(link).tooltip();
      return $("<li />").html(link);
    }

    return this;
  };

  $(function () {
    if($('body.blacklight-catalog-index').length) {

      var spin_options = {
        length: 3,
        width: 2,
        radius: 4,
        left: 5,
        top: 0
      };

      $('.document').each(function() {
        var openUrl = $(this).find(".Z3988").attr("title");
        var id = $(this).attr("id");
        $(this).find('.fulltext').addResource(openUrl, id, "fulltext_short", spin_options);
      });      
    }
    else if($('body.blacklight-catalog-show').length) {

      var spin_options = {
        length: 4,
        width: 3,
        radius: 5,
        top: 0
      };
      var openUrl = $(".Z3988").attr("title");
      var id = $("input[name=id]").val();
      $('.fulltext-header').addResource(openUrl, id, "fulltext", spin_options, 'after');
    }
  });

})(jQuery);
